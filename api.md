# 海战棋服务端 API 使用文档

## 1. 基本信息
- 基础 URL：`http://<服务器IP>:8000`
- 所有 REST 接口均返回 JSON，除 WebSocket 外无需保持长连接。
- 玩家编号：`0` 表示玩家 A，`1` 表示玩家 B，`2` 为只读观战端（不可提交操作）。
- 坐标系：`(x, y)` 以 `0` 为起点，向下为 `x` 递增，向右为 `y` 递增。

## 2. 状态编码
### 2.1 棋盘格值
| 值 | 含义 |
| --- | --- |
| 0 | 未探索 |
| 1 | 攻击落空 |
| 2 | 未被命中的我方舰船 |
| 3 | 命中但未击沉的敌方舰船 |
| 4 | 命中且击沉的敌方舰船 |
| 5 | 触发胜利（仅攻击接口返回） |

### 2.2 对局状态
`/game/status` 返回字段 `state`：

| 值 | 含义 |
| --- | --- |
| 0 | 准备阶段（双方布阵/准备中） |
| 1 | 轮到玩家 A |
| 2 | 轮到玩家 B |
| 3 | 玩家 A 获胜 |
| 4 | 玩家 B 获胜 |

## 3. 配置接口
> 默认配置（服务启动时）：`size = 10`，舰船集合 `{5:1, 4:1, 3:2, 2:1}`。

### 3.1 获取当前配置 `GET /config/get`
**响应示例：**
```json
{
	"size": 10,
	"ships": {"5": 1, "4": 1, "3": 2, "2": 1}
}
```

### 3.2 设置待生效配置 `POST /config/set`
**请求体：**
```json
{
	"size": 12,
	"ships": {"4": 2, "3": 3, "2": 2}
}
```
**响应：**
```json
{"success": true}
```
> 该接口仅更新全局配置草稿，不会立刻影响当前对局。

### 3.3 重新开局 `GET /config/reset`
触发后会基于最近一次 `/config/set` 的内容实例化新的 `Game` 对象并清空双方状态。

**响应：** `{"success": true}`。
> 若未调用 `/config/set`，`reset` 会使用默认配置重置；请在双方布阵前完成该流程。

## 4. 游戏接口
完整流程：配置 -> 提交布阵 -> Ready -> 轮流攻击 -> 判胜。

### 4.1 提交布阵 `POST /game/submit`
**请求体：**
```json
{
	"player": 0,
	"ships": {
		"5": [[0, 0, 0]],
		"4": [[2, 3, 1]],
		"3": [[5, 1, 0], [7, 7, 1]],
		"2": [[9, 0, 0]]
	}
}
```
字段说明：`size` 为舰长，数组元素 `[x, y, d]` 表示起点及方向，`d=0` 水平向右，`d=1` 垂直向下。服务器会校验是否越界、重叠或相邻。

**响应：** `{"success": true}` 或 `false`。

### 4.2 标记准备 `POST /game/ready/{player}`
示例：`POST /game/ready/0`

双方均返回 `{"success": true}` 后，服务器进入 A 先手回合并向玩家 A 广播 “Your Turn.”。

### 4.3 查询状态 `GET /game/status`
返回当前 `state` 数值，可用于客户端轮询。

### 4.4 查看棋盘 `GET /game/board/{player}`
示例：
- 玩家：`GET /game/board/1`
- 观战端：`GET /game/board/2`

**玩家响应：**
```json
{
	"self": [[0,2,0,...], ...],
	"opponent": [[0,0,1,...], ...]
}
```
`self` 为本方完整棋盘，`opponent` 隐藏尚未被发现的敌舰（值 2 会被替换为 0）。

**观战响应：**
```json
{
	"player0": [[0,0,0,...], ...],
	"player1": [[0,0,0,...], ...]
}
```
观战端会一次返回双方棋盘概览，其中未被发现的舰艇也会被隐藏（2→0），仅用于展示当前攻击结果。

### 4.5 发起攻击 `POST /game/attack`
**请求体：**
```json
{
	"player": 0,
	"pos": [3, 6]
}
```
**响应：**
- `{"result": 1}` 攻击落空并轮到对方
- `{"result": 3}` 命中但未击沉
- `{"result": 4}` 击沉舰船
- `{"result": 5}` 瞬时获胜
- `{"error": "Invalid move"}` 非法操作（未轮到、重复坐标等）

服务器在落空时会切换操作权并向另一名玩家广播 “Your Turn.”。

### 4.6 查询舰船损毁情况 `GET /game/ships`
**响应示例：**
```json
{
	"player0": {"5": [1, 0], "4": [1, 0], "3": [2, 0], "2": [1, 0]},
	"player1": {"5": [0, 1], "4": [1, 0], "3": [1, 1], "2": [0, 1]}
}
```
- `player0`/`player1`：分别表示玩家 A/B。
- 数组含义：`[存活舰船数量, 已被击沉数量]`，索引按舰船长度（键名）划分。
- 准备阶段会给出配置中预期的舰船数量（全部视作“存活”）。

## 5. WebSocket 通知
### 5.1 连接地址 `ws://<服务器IP>:8000/ws/{player}`
示例：
- 玩家 A 连接 `ws://127.0.0.1:8000/ws/0`
- 观战端连接 `ws://127.0.0.1:8000/ws/2`

用途：
- 接收服务器广播的提示，例如轮次提醒、心跳（每 30 秒发送一次 `"heartbeat"`）。
- 玩家端同一时间仅允许一个 WebSocket 连接（防止重复输入），观战端数量不限。
- 发送的任意文本消息会广播给所有连接者（玩家与观战端），内容格式为 `Player X says: ...`。
- 当观战端以 `player = 2` 连接时，会同步收到针对玩家的广播信息，并附带“Update for player X”前缀，便于展示。

## 6. 推荐客户端流程
1. （可选）调用 `/config/get` 查询对局参数。
2. 双方依次调用 `/game/submit` 提交布阵。
3. 双方分别调用 `/game/ready/{player}`，等待 `state` 切换到 1（玩家 A 回合）。
4. 轮流：先通过轮询 `/game/status` 或 WebSocket 判断轮次，再调用 `/game/attack`。
5. 可随时用 `/game/board/{player}` 更新本地棋盘。
6. 当 `/game/status` 返回 3/4 或 `/game/attack` 返回 `result = 5` 时判定胜负。
7. 若需重新开始，（可选）先调用 `POST /config/set` 修改参数，再 `GET /config/reset` 重新开局。

